# AMI Worker Fault Injection Test Configurations
# ==============================================
# Source this file to quickly set up different testing scenarios
#
# Usage:
#   source scripts/test_scenarios.env
#   ./scripts/test_worker_robustness.sh moth_binary

# Common settings for all tests
export AMI_TEST_FAULT_INJECTION_ENABLED="true"
export AMI_ANTENNA_SERVICE_NAME="Test Worker (Fault Injection)"

# Permanent error images (customize these to match your test data)
export AMI_TEST_PERMANENT_ERROR_IMAGES="test_permanent_error_1.jpg,test_permanent_error_2.jpg,corrupted_image.png"

# Test Scenario Functions
# =======================

# Scenario 1: Light testing (good for initial verification)
test_light() {
    export AMI_TEST_WORKER_CRASH_RATE="0.02"     # 2% crash rate
    export AMI_TEST_NETWORK_ERROR_RATE="0.01"    # 1% network errors
    export AMI_TEST_CORRUPT_IMAGE_RATE="0.005"   # 0.5% corrupt images
    export AMI_TEST_IMAGE_404_RATE="0.005"       # 0.5% 404 errors
    export AMI_TEST_TRANSIENT_ERROR_RATE="0.01"  # 1% transient errors
    echo "‚úÖ Light fault injection configured (low error rates)"
}

# Scenario 2: Medium testing (balanced for normal testing)
test_medium() {
    export AMI_TEST_WORKER_CRASH_RATE="0.05"     # 5% crash rate
    export AMI_TEST_NETWORK_ERROR_RATE="0.03"    # 3% network errors
    export AMI_TEST_CORRUPT_IMAGE_RATE="0.02"    # 2% corrupt images
    export AMI_TEST_IMAGE_404_RATE="0.02"        # 2% 404 errors
    export AMI_TEST_TRANSIENT_ERROR_RATE="0.04"  # 4% transient errors
    echo "‚öñÔ∏è  Medium fault injection configured (moderate error rates)"
}

# Scenario 3: Heavy testing (stress test)
test_heavy() {
    export AMI_TEST_WORKER_CRASH_RATE="0.1"      # 10% crash rate
    export AMI_TEST_NETWORK_ERROR_RATE="0.08"    # 8% network errors
    export AMI_TEST_CORRUPT_IMAGE_RATE="0.05"    # 5% corrupt images
    export AMI_TEST_IMAGE_404_RATE="0.05"        # 5% 404 errors
    export AMI_TEST_TRANSIENT_ERROR_RATE="0.07"  # 7% transient errors
    echo "üî• Heavy fault injection configured (high error rates)"
}

# Scenario 4: Worker crash focused
test_worker_crashes() {
    export AMI_TEST_WORKER_CRASH_RATE="0.15"     # 15% crash rate
    export AMI_TEST_NETWORK_ERROR_RATE="0.01"    # 1% network errors
    export AMI_TEST_CORRUPT_IMAGE_RATE="0.01"    # 1% corrupt images
    export AMI_TEST_IMAGE_404_RATE="0.01"        # 1% 404 errors
    export AMI_TEST_TRANSIENT_ERROR_RATE="0.02"  # 2% transient errors
    echo "üí• Worker crash focused testing configured"
}

# Scenario 5: Network error focused
test_network_errors() {
    export AMI_TEST_WORKER_CRASH_RATE="0.02"     # 2% crash rate
    export AMI_TEST_NETWORK_ERROR_RATE="0.15"    # 15% network errors
    export AMI_TEST_CORRUPT_IMAGE_RATE="0.01"    # 1% corrupt images
    export AMI_TEST_IMAGE_404_RATE="0.01"        # 1% 404 errors
    export AMI_TEST_TRANSIENT_ERROR_RATE="0.08"  # 8% transient errors
    echo "üåê Network error focused testing configured"
}

# Scenario 6: Image error focused
test_image_errors() {
    export AMI_TEST_WORKER_CRASH_RATE="0.02"     # 2% crash rate
    export AMI_TEST_NETWORK_ERROR_RATE="0.01"    # 1% network errors
    export AMI_TEST_CORRUPT_IMAGE_RATE="0.1"     # 10% corrupt images
    export AMI_TEST_IMAGE_404_RATE="0.1"         # 10% 404 errors
    export AMI_TEST_TRANSIENT_ERROR_RATE="0.02"  # 2% transient errors
    echo "üì∑ Image error focused testing configured"
}

# Scenario 7: No crashes (test error handling without worker restarts)
test_no_crashes() {
    export AMI_TEST_WORKER_CRASH_RATE="0.0"      # No crashes
    export AMI_TEST_NETWORK_ERROR_RATE="0.05"    # 5% network errors
    export AMI_TEST_CORRUPT_IMAGE_RATE="0.03"    # 3% corrupt images
    export AMI_TEST_IMAGE_404_RATE="0.03"        # 3% 404 errors
    export AMI_TEST_TRANSIENT_ERROR_RATE="0.05"  # 5% transient errors
    echo "üõ°Ô∏è  No-crash testing configured (errors without worker restarts)"
}

# Disable all fault injection
test_disable() {
    export AMI_TEST_FAULT_INJECTION_ENABLED="false"
    echo "‚ùå Fault injection disabled"
}

# Helper function to show current configuration
show_config() {
    if [[ "${AMI_TEST_FAULT_INJECTION_ENABLED:-false}" == "true" ]]; then
        echo "Current fault injection configuration:"
        echo "  Enabled: ‚úÖ"
        echo "  Worker crash rate: ${AMI_TEST_WORKER_CRASH_RATE:-0.0}"
        echo "  Network error rate: ${AMI_TEST_NETWORK_ERROR_RATE:-0.0}"
        echo "  Corrupt image rate: ${AMI_TEST_CORRUPT_IMAGE_RATE:-0.0}"
        echo "  Image 404 rate: ${AMI_TEST_IMAGE_404_RATE:-0.0}"
        echo "  Transient error rate: ${AMI_TEST_TRANSIENT_ERROR_RATE:-0.0}"
        echo "  Permanent error images: ${AMI_TEST_PERMANENT_ERROR_IMAGES:-none}"
        echo "  Service name: ${AMI_ANTENNA_SERVICE_NAME:-not set}"
    else
        echo "Fault injection: ‚ùå DISABLED"
    fi
}

# Show available scenarios
show_scenarios() {
    cat << 'EOF'
Available test scenarios:

  test_light          - Low error rates (2% crashes, 1% network errors)
  test_medium         - Medium error rates (5% crashes, 3% network errors)
  test_heavy          - High error rates (10% crashes, 8% network errors)
  test_worker_crashes - Focus on worker crashes (15% crash rate)
  test_network_errors - Focus on network issues (15% network error rate)
  test_image_errors   - Focus on image problems (10% image error rates)
  test_no_crashes     - Test error handling without worker crashes
  test_disable        - Disable all fault injection

Usage:
  source scripts/test_scenarios.env
  test_medium
  ./scripts/test_worker_robustness.sh moth_binary

Other functions:
  show_config         - Show current configuration
  show_scenarios      - Show this help
EOF
}

echo "üß™ AMI fault injection scenarios loaded"
echo "Run 'show_scenarios' to see available test configurations"
echo "Run 'show_config' to see current settings"
